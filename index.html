<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тест: Дефицит железа</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #fff;
            --tg-theme-text-color: #000;
            --tg-theme-hint-color: #999;
            --tg-theme-link-color: #2481cc;
            --tg-theme-button-color: #2481cc;
            --tg-theme-button-text-color: #fff;
            --accent-color: #fe6b6b;
            --card-bg: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 80px;
            transition: padding-bottom 0.3s ease;
        }

        .question-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .question-card.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--accent-color);
        }

        .option-group {
            display: grid;
            gap: 12px;
        }

        .radio-option {
            position: relative;
            padding: 16px;
            background: rgba(36, 129, 204, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .radio-option:hover {
            background: rgba(36, 129, 204, 0.2);
        }

        .radio-option input[type="radio"] {
            position: absolute;
            opacity: 0;
        }

        .radio-option input[type="radio"]:checked + label {
            color: var(--accent-color);
            font-weight: 500;
        }

        .radio-option label {
            display: block;
            cursor: pointer;
            padding-left: 28px;
            position: relative;
        }

        .radio-option label::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            border: 2px solid var(--accent-color);
            border-radius: 50%;
        }

        .radio-option input[type="radio"]:checked + label::after {
            content: '';
            position: absolute;
            left: 4px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: var(--accent-color);
            border-radius: 50%;
        }

        .rating-group {
            display: flex;
            flex-direction: column;
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .symptom-text {
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .rating-options {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: nowrap;
        }

        .rating-option {
            text-align: center;
        }

        .rating-option input[type="radio"] {
            display: none;
        }

        .rating-option label {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            font-size: 0.9rem;
            border: 1px solid var(--tg-theme-hint-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .rating-option input[type="radio"]:checked + label {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .rating-description {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 5px;
            font-size: 0.75rem;
            color: var(--tg-theme-hint-color);
        }

        .rating-description span {
            width: 36px;
            text-align: center;
        }

        .text-input {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(128, 128, 128, 0.2);
            border-radius: 8px;
            margin-top: 10px;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
        }

        .navigation {
            display: none;
        }

        button[type="button"] {
            padding: 12px 24px;
            font-size: 1rem;
            border-radius: 8px;
            border: none;
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            cursor: pointer;
            width: auto;
            min-width: 120px;
        }

        button[type="submit"] {
            padding: 12px 24px;
            font-size: 1rem;
            border-radius: 8px;
            border: none;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            width: auto;
            min-width: 120px;
        }

        button:hover {
            opacity: 0.9;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .progress-bar {
            height: 4px;
            background: rgba(128, 128, 128, 0.2);
            border-radius: 2px;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-color);
            border-radius: 2px;
            width: 0;
            transition: width 0.3s ease;
        }

        #otherInput {
            display: none;
        }

        .checkbox-option {
            position: relative;
            padding: 16px;
            background: rgba(36, 129, 204, 0.1);
            border-radius: 12px;
            cursor: pointer;
            margin-bottom: 8px;
        }

        .checkbox-option input[type="checkbox"] {
            position: absolute;
            opacity: 0;
        }

        .checkbox-option label {
            display: block;
            cursor: pointer;
            padding-left: 28px;
            position: relative;
        }

        .checkbox-option label::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            border: 2px solid var(--accent-color);
            border-radius: 4px;
        }

        .checkbox-option input[type="checkbox"]:checked + label::after {
            content: '✓';
            position: absolute;
            left: 4px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--accent-color);
        }

        .results-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            margin-top: 24px;
            animation: fadeIn 0.5s ease;
        }

        .results-card h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        .result-text {
            white-space: pre-line;
            line-height: 1.6;
            margin-top: 20px;
        }

        .score {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--accent-color);
            margin: 16px 0;
            text-align: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-image {
            width: 100%;
            max-width: 300px;
            height: auto;
            border-radius: 16px;
            margin: 20px auto;
            display: block;
        }

        .lesson-button {
            background: #4CAF50;
            color: white;
            padding: 16px 32px;
            border-radius: 12px;
            border: none;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            display: block;
            margin: 24px auto;
            transition: background-color 0.3s ease;
        }

        .lesson-button:hover {
            background: #45a049;
        }

        /* Стили для карточки подписки */
        .subscription-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            margin-top: 24px;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }

        .subscription-card h2 {
            margin-bottom: 16px;
        }

        .channel-link {
            display: inline-block;
            color: var(--accent-color);
            font-weight: bold;
            font-size: 1.1rem;
            margin: 16px 0;
            text-decoration: none;
        }

        .channel-link:hover {
            text-decoration: underline;
        }

        .channel-image {
            width: 100%;
            max-width: 250px;
            height: auto;
            border-radius: 16px;
            margin: 20px auto;
            display: block;
        }

        .check-subscription-button {
            background: var(--accent-color);
            color: white;
            padding: 16px 32px;
            border-radius: 12px;
            border: none;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            display: block;
            margin: 24px auto;
            transition: background-color 0.3s ease;
        }

        .check-subscription-button:hover {
            opacity: 0.9;
        }

        .check-subscription-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Анимация встряски для карточки подписки */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        .footer {
            text-align: center;
            padding: 20px;
            margin-top: auto;
            color: var(--tg-theme-hint-color);
            font-size: 0.9rem;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--tg-theme-bg-color);
            z-index: 1000;
        }

        .footer a {
            color: var(--tg-theme-link-color);
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 360px) {
            .rating-option label {
                width: 32px;
                height: 32px;
                font-size: 0.8rem;
            }
            
            .rating-description {
                font-size: 0.7rem;
            }
            
            .rating-description span {
                width: 32px;
            }
        }

        /* Стили для кнопки в виде ссылки */
        a.lesson-button {
            display: inline-block;
            text-align: center;
            text-decoration: none;
            background: #4CAF50;
            color: white;
            padding: 16px 32px;
            border-radius: 12px;
            border: none;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            margin: 24px auto;
            transition: background-color 0.3s ease;
        }

        a.lesson-button:hover {
            background: #45a049;
        }

        .channel-name {
            font-weight: bold;
            color: var(--accent-color);
            font-size: 1.1rem;
            margin: 10px 0;
        }

        .subscribe-button {
            display: inline-block;
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            padding: 14px 28px;
            border-radius: 12px;
            text-decoration: none;
            font-size: 1.1rem;
            font-weight: 500;
            margin: 16px auto;
            transition: background-color 0.3s ease;
            cursor: pointer;
        }

        .subscribe-button:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar"></div>
        </div>

        <form id="testForm">
            <!-- Вопрос 1 -->
            <div class="question-card active" id="q1">
                <h2>1. Чем вы занимаетесь?</h2>
                <div class="option-group">
                    <div class="radio-option">
                        <input type="radio" name="occupation" value="Тренер" id="trainer">
                        <label for="trainer">Тренер</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" name="occupation" value="Спортсмен" id="athlete">
                        <label for="athlete">Спортсмен</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" name="occupation" value="Врач" id="doctor">
                        <label for="doctor">Врач</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" name="occupation" value="Нутрициолог" id="nutritionist">
                        <label for="nutritionist">Нутрициолог</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" name="occupation" value="Предприниматель" id="businessman">
                        <label for="businessman">Предприниматель</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" name="occupation" value="Менеджер" id="manager">
                        <label for="manager">Менеджер</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" name="occupation" value="Психолог, коуч" id="psychologist">
                        <label for="psychologist">Психолог, коуч</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" name="occupation" value="other" id="other">
                        <label for="other">Другое</label>
                    </div>
                    <input type="text" id="otherInput" class="text-input" placeholder="Укажите вашу профессию">
                </div>
            </div>

            <!-- Вопрос 2 -->
            <div class="question-card" id="q2">
                <h2>2. Для кого вы хотите получить знания про дефицит железа?</h2>
                <div class="option-group">
                    <div class="radio-option">
                        <input type="radio" name="purpose" value="Для себя" id="self">
                        <label for="self">Для себя</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" name="purpose" value="Для улучшения результатов своих клиентов/пациентов" id="clients">
                        <label for="clients">Для улучшения результатов своих клиентов/пациентов</label>
                    </div>
                </div>
            </div>

            <!-- Динамические вопросы 3.1 или 3.2 -->
            <div class="question-card" id="q3">
                <h2 id="q3Title"></h2>
                <div id="symptomsContainer"></div>
            </div>

            <!-- Вопрос 4 -->
            <div class="question-card" id="q4">
                <h2>4. Что бы вы хотели больше всего узнать?</h2>
                <div class="option-group">
                    <div class="radio-option">
                        <input type="radio" name="interest" value="Препараты: каким можно верить" id="metabolism">
                        <label for="metabolism">Препараты: каким можно верить</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" name="interest" value="Анализы: как разобраться?" id="analysis">
                        <label for="analysis">Анализы: как разобраться?</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" name="interest" value="Функции железа" id="supplements">
                        <label for="supplements">Функции железа</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" name="interest" value="другое" id="other_interest">
                        <label for="other_interest">Другое (напиши свое)</label>
                    </div>
                    <input type="text" id="otherInterestInput" class="text-input" placeholder="Укажите что именно" style="display: none;">
                </div>
            </div>

            <!-- Вопрос 5 -->
            <div class="question-card" id="q5">
                <h2>5. В каком формате вы хотите получить информацию?</h2>
                <div class="checkbox-group">
                    <div class="checkbox-option">
                        <input type="checkbox" name="format" value="Посмотреть: видеоуроки" id="video">
                        <label for="video">Посмотреть: видеоуроки</label>
                    </div>
                    <div class="checkbox-option">
                        <input type="checkbox" name="format" value="Почитать: гайды" id="guide">
                        <label for="guide">Почитать: гайды</label>
                    </div>
                    <div class="checkbox-option">
                        <input type="checkbox" name="format" value="Спросить: консультация со мной" id="consultation">
                        <label for="consultation">Спросить: консультация со мной</label>
                    </div>
                </div>
            </div>

            <!-- Общий футер для всех страниц кроме результатов -->
            <div class="footer" id="commonFooter">
                <a href="https://t.me/maxim_obukhov" target="_blank">Если возникли сложности - напишите мне лично</a>
            </div>
        </form>
    </div>

    <script>
        const tg = window.Telegram?.WebApp || {};
        const webapp = window.Telegram.WebApp;
        const mainButton = webapp.MainButton;
        const secondaryButton = webapp.SecondaryButton;
        
        if (tg.expand) {
            tg.expand();
        }

        let currentQuestion = 1;
        const totalQuestions = 5;
        let formData = {
            telegramId: tg.initDataUnsafe?.user?.id || null,
            профессия: '',
            цель: '',
            симптомы: {},
            общий_балл: 0,
            форматы: []
        };

        // Функция для сохранения прогресса
        function saveProgress() {
            try {
                const progressData = {
                    currentQuestion: currentQuestion,
                    formData: formData
                };
                localStorage.setItem('ironTestProgress', JSON.stringify(progressData));
                console.log('Прогресс сохранен:', progressData);
            } catch (error) {
                console.error('Ошибка при сохранении прогресса:', error);
            }
        }

        // Функция для загрузки прогресса
        function loadProgress() {
            try {
                const savedProgress = localStorage.getItem('ironTestProgress');
                if (savedProgress) {
                    const progressData = JSON.parse(savedProgress);
                    currentQuestion = progressData.currentQuestion;
                    formData = progressData.formData;
                    console.log('Прогресс загружен:', progressData);
                    
                    // Восстанавливаем ответы на вопросы
                    if (formData.профессия) {
                        const occupationRadio = document.querySelector(`input[name="occupation"][value="${formData.профессия}"]`);
                        if (occupationRadio) {
                            occupationRadio.checked = true;
                        } else {
                            // Если это было "Другое"
                            const otherRadio = document.querySelector('input[name="occupation"][value="other"]');
                            if (otherRadio) {
                                otherRadio.checked = true;
                                const otherInput = document.getElementById('otherInput');
                                if (otherInput) {
                                    otherInput.style.display = 'block';
                                    otherInput.value = formData.профессия;
                                }
                            }
                        }
                    }
                    
                    if (formData.цель) {
                        const purposeRadio = document.querySelector(`input[name="purpose"][value="${formData.цель}"]`);
                        if (purposeRadio) {
                            purposeRadio.checked = true;
                        }
                    }
                    
                    // Восстанавливаем симптомы если они есть
                    if (Object.keys(formData.симптомы).length > 0) {
                        // Если текущий вопрос 3 или выше, создаем форму симптомов
                        if (currentQuestion >= 3) {
                            const purpose = document.querySelector('input[name="purpose"]:checked');
                            const forClients = purpose && purpose.value === 'Для улучшения результатов своих клиентов/пациентов';
                            createSymptomsForm(forClients);
                            
                            // Восстанавливаем выбранные симптомы
                            for (const key in formData.симптомы) {
                                const symptomIndex = parseInt(key.replace('симптом_', '')) - 1;
                                const value = formData.симптомы[key].оценка;
                                const radio = document.querySelector(`input[name="symptom${symptomIndex}"][value="${value}"]`);
                                if (radio) {
                                    radio.checked = true;
                                }
                            }
                        }
                    }
                    
                    // Восстанавливаем выбранные интересы
                    if (formData.интерес) {
                        const interestRadio = document.querySelector(`input[name="interest"][value="${formData.интерес}"]`);
                        if (interestRadio) {
                            interestRadio.checked = true;
                        } else {
                            // Если это было "другое"
                            const otherInterestRadio = document.querySelector('input[name="interest"][value="другое"]');
                            if (otherInterestRadio) {
                                otherInterestRadio.checked = true;
                                const otherInterestInput = document.getElementById('otherInterestInput');
                                if (otherInterestInput) {
                                    otherInterestInput.style.display = 'block';
                                    otherInterestInput.value = formData.интерес;
                                }
                            }
                        }
                    }
                    
                    // Восстанавливаем выбранные форматы
                    if (formData.форматы && formData.форматы.length > 0) {
                        formData.форматы.forEach(format => {
                            const formatCheckbox = document.querySelector(`input[name="format"][value="${format}"]`);
                            if (formatCheckbox) {
                                formatCheckbox.checked = true;
                            }
                        });
                    }
                    
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Ошибка при загрузке прогресса:', error);
                return false;
            }
        }

        // Функция для очистки прогресса
        function clearProgress() {
            try {
                localStorage.removeItem('ironTestProgress');
                console.log('Прогресс очищен');
            } catch (error) {
                console.error('Ошибка при очистке прогресса:', error);
            }
        }

        // Симптомы для вопроса 3
        const symptoms = [
            "Слабость, повышенная утомляемость, сложность встать по будильнику",
            "Раздражительность, психологическая лабильность, депрессивное поведение",
            "Снижение мотивации, трудоспособности, эффективности, концентрации внимания и памяти",
            "Повышенная предрасположенность к инфекциям (герпес, фурункулез, ИППП, частые ОРВИ, ОРЗ, стоматит)",
            "Одышка и сердцебиение при обычных физических нагрузках, ухудшение восстановления после физических нагрузок, снижение силовых, выносливости. Сложность набрать вес/ похудеть",
            "Зябкость рук, ног, непроизвольное желание шевелить/двигать ногами перед засыпанием",
            "Сухость кожи, шелушение, сухие локти, трещины кожи пяток, пальцев, кожный зуд, коричневые пятна на тыльной поверхности кистей и лица",
            "Ложкообразная вогнутость, исчерченность ногтей. Тусклость, ломкость, выпадение волос, ранняя седина",
            "Извращение вкуса (хочется съесть мел, глину, фарш, тесто, землю). Пристрастие к запахам (бензин, керосин, ацетон, запах краски)",
            "Неустойчивый стул, снижение желудочной секреции (нет аппетита на мясо/рыбу), атрофический гастрит, запоры"
        ];

        function updateProgressBar() {
            const progress = (currentQuestion / totalQuestions) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }

        function showQuestion(num) {
            console.log('Показываем вопрос:', num);
            
            document.querySelectorAll('.question-card').forEach(card => {
                card.classList.remove('active');
            });
            document.getElementById(`q${num}`).classList.add('active');
            updateProgressBar();
            
            // Обновляем SecondaryButton вместо BackButton
            if (num > 1) {
                secondaryButton.show();
                console.log('Показываем кнопку "Назад" (SecondaryButton) для вопроса', num);
            } else {
                secondaryButton.hide();
                console.log('Скрываем кнопку "Назад" (SecondaryButton) для вопроса', num);
            }
            
            // Явно обновляем MainButton
            try {
                // Обновляем текст кнопки
                if (num === totalQuestions) {
                    mainButton.setText('Отправить');
                    console.log('Устанавливаем текст кнопки "Отправить" для последнего вопроса');
                } else {
                    mainButton.setText('Далее');
                    console.log('Устанавливаем текст кнопки "Далее" для вопроса', num);
                }
                
                // Принудительно показываем кнопку
                mainButton.show();
                mainButton.enable(); // Всегда активируем кнопку
                console.log('MainButton показана для вопроса', num);
                
            } catch (error) {
                console.error('Ошибка при обновлении MainButton:', error);
            }
        }

        function createSymptomsForm(forClients) {
            const container = document.getElementById('symptomsContainer');
            container.innerHTML = '';
            document.getElementById('q3Title').textContent = forClients ? 
                "3.1 Что чаще всего встречается у ваших клиентов/пациентов?" :
                "3.2 Какие симптомы чаще/сильнее встречаются у вас?";

            symptoms.forEach((symptom, index) => {
                const symptomGroup = document.createElement('div');
                symptomGroup.className = 'rating-group';
                symptomGroup.innerHTML = `
                    <div class="symptom-text">${symptom}</div>
                    <div class="rating-description">
                        <span>нет</span>
                        <span>редко</span>
                        <span>иногда</span>
                        <span>часто</span>
                        <span>всегда</span>
                    </div>
                    <div class="rating-options">
                        ${[0, 1, 2, 3, 4].map(value => `
                            <div class="rating-option">
                                <input type="radio" name="symptom${index}" value="${value}" id="s${index}r${value}">
                                <label for="s${index}r${value}">${value}</label>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(symptomGroup);
            });

            // Добавляем поле "Другое"
            const otherGroup = document.createElement('div');
            otherGroup.innerHTML = `
                <div class="form-group">
                    <label>11. Другое (если есть)</label>
                    <input type="text" class="text-input" id="otherSymptoms" placeholder="Опишите другие симптомы">
                </div>
            `;
            container.appendChild(otherGroup);
        }

        function validateQuestion(num) {
            switch(num) {
                case 1:
                    const occupation = document.querySelector('input[name="occupation"]:checked');
                    if (!occupation) return false;
                    if (occupation.value === 'other' && !document.getElementById('otherInput').value.trim()) return false;
                    return true;
                case 2:
                    const purpose = document.querySelector('input[name="purpose"]:checked');
                    if (!purpose) return false;
                    return true;
                case 3:
                    // Проверяем заполнение всех 10 симптомов
                    const totalSymptoms = 10; // 10 основных симптомов
                    let answeredSymptoms = 0;
                    
                    // Считаем количество ответов на основные симптомы
                    for (let i = 0; i < totalSymptoms; i++) {
                        if (document.querySelector(`input[name="symptom${i}"]:checked`)) {
                            answeredSymptoms++;
                        }
                    }
                    
                    // Проверяем, все ли симптомы оценены
                    return answeredSymptoms === totalSymptoms;
                case 4:
                    const interest = document.querySelector('input[name="interest"]:checked');
                    if (!interest) return false;
                    if (interest.value === 'другое') {
                        const otherText = document.getElementById('otherInterestInput').value.trim();
                        if (!otherText) return false;
                    }
                    return true;
                case 5:
                    const format = document.querySelector('input[name="format"]:checked');
                    if (!format) return false;
                    if (format.value === 'other_format' && !document.getElementById('otherFormatInput').value.trim()) return false;
                    return true;
                default:
                    return true;
            }
        }

        function getStartAppParams() {
            try {
                // Получаем данные из правильного ключа в sessionStorage
                const initDataRaw = sessionStorage.getItem('__telegram__initParams');
                if (!initDataRaw) return null;

                const initData = JSON.parse(initDataRaw);
                
                // Декодируем tgWebAppData
                const webAppDataStr = decodeURIComponent(initData.tgWebAppData);
                
                // Ищем start_param в строке
                const startParamMatch = webAppDataStr.match(/start_param=([^&]+)/);
                if (!startParamMatch) return null;
                
                const startParam = startParamMatch[1];
                
                // Разбиваем параметры по '_'
                const utmParams = startParam.split('_');
                const utmNames = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_content', 'utm_term'];
                
                const result = {};
                utmParams.forEach((param, index) => {
                    if (index < utmNames.length) {
                        result[utmNames[index]] = param;
                    }
                });

                return result;
            } catch (error) {
                console.error('Ошибка при разборе параметров:', error);
                return null;
            }
        }

        function collectFormData() {
            const formData = {
                telegramId: tg.initDataUnsafe?.user?.id || null,
                профессия: '',
                цель: document.querySelector('input[name="purpose"]:checked')?.value || '',
                симптомы: {},
                общий_балл: 0,
                форматы: Array.from(document.querySelectorAll('input[name="format"]:checked'))
                    .map(input => input.value)
            };

            // Обработка поля "профессия"
            const occupationInput = document.querySelector('input[name="occupation"]:checked');
            if (occupationInput) {
                if (occupationInput.id === 'other') {
                    formData.профессия = document.getElementById('otherInput').value.trim();
                } else {
                    formData.профессия = occupationInput.value;
                }
            }

            // Подсчет баллов и сбор симптомов
            let totalScore = 0;
            symptoms.forEach((symptom, index) => {
                const rating = document.querySelector(`input[name="symptom${index}"]:checked`);
                if (rating) {
                    const value = parseInt(rating.value);
                    formData.симптомы[`симптом_${index + 1}`] = {
                        описание: symptom,
                        оценка: value
                    };
                    totalScore += value;
                }
            });
            
            // Добавляем общий балл
            formData.общий_балл = totalScore;

            // Для вопроса 4
            const interest = document.querySelector('input[name="interest"]:checked');
            if (interest) {
                formData.интерес = interest.value === 'другое' ? 
                    document.getElementById('otherInterestInput').value : 
                    interest.value;
            }

            // Добавление другой информации пользователя из Telegram, если доступна
            if (tg.initDataUnsafe?.user) {
                formData.имя_пользователя = tg.initDataUnsafe.user.first_name || '';
                formData.фамилия = tg.initDataUnsafe.user.last_name || '';
                formData.username = tg.initDataUnsafe.user.username || '';
            }

            return formData;
        }

        // Заменяем инициализацию BackButton на SecondaryButton
        function updateBackButton() {
            try {
                // Настраиваем SecondaryButton
                secondaryButton.setText('Назад');
                secondaryButton.setParams({
                    text_color: '#8774e1',
                    is_visible: currentQuestion > 1,
                    is_active: true
                });
                
                if (currentQuestion > 1) {
                    console.log('Активируем кнопку "Назад" (SecondaryButton) для вопроса', currentQuestion);
                    secondaryButton.show();
                } else {
                    console.log('Скрываем кнопку "Назад" (SecondaryButton) для вопроса', currentQuestion);
                    secondaryButton.hide();
                }
            } catch (error) {
                console.error('Ошибка при обновлении SecondaryButton:', error);
            }
        }

        // Обновляем функцию nextQuestion для показа сообщения
        function nextQuestion(num) {
            if (!validateQuestion(num)) {
                if (num === 3) {
                    alert('Пожалуйста, ответьте на все вопросы о симптомах, прежде чем продолжить');
                } else {
                    alert('Пожалуйста, ответьте на вопрос');
                }
                return;
            }

            if (num === 2) {
                const purpose = document.querySelector('input[name="purpose"]:checked');
                createSymptomsForm(purpose.value === 'Для улучшения результатов своих клиентов/пациентов');
            }

            currentQuestion = num + 1;
            showQuestion(currentQuestion);
            updateBackButton();
            // Сохраняем прогресс после перехода к следующему вопросу
            saveProgress();
        }

        function prevQuestion(num) {
            currentQuestion = num - 1;
            showQuestion(currentQuestion);
            // Сохраняем прогресс после возврата к предыдущему вопросу
            saveProgress();
        }

        // Добавляем обработчик для поля ввода текста
        function setupEventListeners() {
            // Для первого вопроса
            const otherOption = document.getElementById('other');
            const otherInput = document.getElementById('otherInput');
            if (otherOption && otherInput) {
                otherOption.addEventListener('change', function() {
                    otherInput.style.display = this.checked ? 'block' : 'none';
                });
                
                // Добавляем обработчик для текстового поля
                otherInput.addEventListener('input', function() {
                    if (otherOption.checked && this.value.trim() !== '') {
                        mainButton.enable();
                    } else if (otherOption.checked) {
                        mainButton.disable();
                    }
                });
            }

            // Для формата (множественный выбор)
            const formatInputs = document.querySelectorAll('input[name="format"]');
            formatInputs.forEach(input => {
                input.addEventListener('change', function() {
                    const otherFormatInput = document.getElementById('otherFormatInput');
                    if (this.id === 'other_format' && otherFormatInput) {
                        otherFormatInput.style.display = this.checked ? 'block' : 'none';
                    }
                });
            });

            // Обработчик для поля "другое" в вопросе 4
            document.getElementById('other_interest')?.addEventListener('change', function() {
                const otherInput = document.getElementById('otherInterestInput');
                if (otherInput) {
                    otherInput.style.display = this.checked ? 'block' : 'none';
                }
            });
            
            // Добавляем обработчик для текстового поля в вопросе 4
            const otherInterestInput = document.getElementById('otherInterestInput');
            if (otherInterestInput) {
                otherInterestInput.addEventListener('input', function() {
                    const otherInterest = document.getElementById('other_interest');
                    if (otherInterest && otherInterest.checked && this.value.trim() !== '') {
                        mainButton.enable();
                    } else if (otherInterest && otherInterest.checked) {
                        mainButton.disable();
                    }
                });
            }
        }

        // Функция для открытия ссылки
        function openMaterials() {
            try {
                // Используем метод Telegram WebApp для открытия ссылки
                if (window.Telegram && window.Telegram.WebApp) {
                    // Используем openTelegramLink чтобы открыть ссылку прямо в Telegram
                    const url = 'https://t.me/obukhov_channel_bot/education';
                    console.log('Открываем ссылку в Telegram:', url);
                    window.Telegram.WebApp.openTelegramLink(url);
                } else {
                    // Запасной вариант, если Telegram WebApp недоступен
                    window.open('https://t.me/obukhov_channel_bot/education', '_blank');
                }
                
                // Закрываем текущее приложение после небольшой задержки
                setTimeout(() => {
                    if (window.Telegram && window.Telegram.WebApp) {
                        window.Telegram.WebApp.close();
                    }
                }, 1000);
                
                // Очищаем прогресс после успешного завершения теста
                clearProgress();
            } catch (error) {
                console.error('Ошибка при открытии ссылки:', error);
                // Запасной вариант в случае ошибки
                window.location.href = 'https://t.me/obukhov_channel_bot/education';
            }
        }

        // Функция для открытия канала
        function openChannel() {
            try {
                if (window.Telegram && window.Telegram.WebApp) {
                    // Используем openTelegramLink чтобы открыть ссылку прямо в Telegram
                    const url = 'https://t.me/obukhov_channel';
                    console.log('Открываем канал в Telegram:', url);
                    window.Telegram.WebApp.openTelegramLink(url);
                } else {
                    window.open('https://t.me/obukhov_channel', '_blank');
                }
            } catch (error) {
                console.error('Ошибка при открытии канала:', error);
                window.location.href = 'https://t.me/obukhov_channel';
            }
        }

        // Функция для проверки подписки
        async function checkSubscription() {
            try {
                const userData = {
                    telegramId: tg.initDataUnsafe?.user?.id || null
                };

                console.log('Проверка подписки для:', userData);

                // Скрываем кнопку на время проверки
                const checkButton = document.querySelector('.check-subscription-button');
                if (checkButton) {
                    checkButton.disabled = true;
                    checkButton.textContent = 'Проверяем...';
                }

                const response = await fetch('https://n8n.snapn8n.ru/webhook/d2293db4-9b3b-4cd9-b462-bfce67951bd6', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                console.log('Статус ответа проверки подписки:', response.status);

                if (checkButton) {
                    checkButton.disabled = false;
                    checkButton.textContent = 'Проверить подписку';
                }

                if (response.status === 200) {
                    // Пользователь подписан, показываем результаты
                    showTestResults();
                } else {
                    // Пользователь не подписан, оставляем экран с приглашением подписаться
                    console.log('Подписка не обнаружена');
                    // Можно добавить анимацию или сообщение о неудачной проверке
                    const subscriptionCard = document.querySelector('.subscription-card');
                    if (subscriptionCard) {
                        subscriptionCard.classList.add('shake');
                        setTimeout(() => {
                            subscriptionCard.classList.remove('shake');
                        }, 500);
                    }
                }
            } catch (error) {
                console.error('Ошибка при проверке подписки:', error);
                alert('Произошла ошибка при проверке подписки. Пожалуйста, попробуйте еще раз.');
                const checkButton = document.querySelector('.check-subscription-button');
                if (checkButton) {
                    checkButton.disabled = false;
                    checkButton.textContent = 'Проверить подписку';
                }
            }
        }

        // Функция для отображения результатов теста
        function showTestResults() {
            // Очищаем прогресс при показе результатов
            clearProgress();
            
            // Удаляем карточку подписки, если она есть
            const subscriptionCard = document.querySelector('.subscription-card');
            if (subscriptionCard) {
                subscriptionCard.remove();
            }

            // Очищаем весь контейнер
            const container = document.querySelector('.container');
            // Сохраняем прогресс-бар
            const progressBar = document.querySelector('.progress-bar');
            const progressBarClone = progressBar ? progressBar.cloneNode(true) : null;
            
            // Очищаем содержимое контейнера
            container.innerHTML = '';
            
            // Возвращаем прогресс-бар
            if (progressBarClone) {
                container.appendChild(progressBarClone);
            }

            const formData = window.savedFormData;
            if (!formData) {
                console.error('Ошибка: данные формы отсутствуют');
                return;
            }

            console.log('Показываем результаты теста');

            const resultsCard = document.createElement('div');
            resultsCard.className = 'results-card';
            
            let resultText = '';
            if (formData.общий_балл <= 10) {
                resultText = `Отличный результат! 
Тест показал, что риск железодефицита низкий. 👍

Сейчас твой организм получает достаточное количество железа для поддержания здоровья — так держать!

Рекомендации: 
- Отслеживать изменения в общем состоянии организма; 
- Пройти тест повторно через 3 месяца, чтобы отследить динамику; 
- Сейчас дать его пройти своей семье, потому что не все такие молодцы, как ты! 😉 

Чтобы узнать, как помогать организму удерживать уровень железа, как не допустить у себя и у близких анемии и какие препараты помогут лучшему его усвоению — залетай на урок или скачивай гайд 📖
Если хочешь разобрать свое здоровье индивидуально - записывайся на консультацию 👇`;
            } else if (formData.общий_балл < 15) {
                resultText = `Хьюстон, у нас проблемы. 

Твои результаты указывают на высокий риск дефицита железа. Корабль ещё не терпит бедствие, но приборная панель уже мигает всеми лампочками. ⚠

Рекомендации:
- Обязательно сдай анализы на железо;
- Добавь в рацион мясо и субпродукты; 
- Если анализы подтвердят проблему — добавь препараты железа и кофакторы из БАДов.

Важно выявить проблему на ранней стадии и принять меры, чтобы избежать серьёзных последствий. Не затягивай! 

Что именно пропить, какие анализы сдать — рассказал в бесплатном уроке! 
Если хочешь в текстовом виде - скачивай гайд. 📖
Хочешь задать лично свои вопросы - запишись на консультацию👇👇👇`;
            } else {
                resultText = `Это фиаско.  
Твои результаты свидетельствуют о критически высоком риске железодефицита. Сигнал серьёзный и требует немедленных действий. Алло, анемия? Вы следующая! ❌

Рекомендации:
- Срочно сдать анализы, чтобы определить уровень железа и начать лечение🩸;
- Добавить в рацион больше мяса и субпродуктов; 
- Возможно, потребуется назначение капельниц железа или высоких дозировок пероральных препаратов 💊

Твой организм мог бы кричать о помощи, но силы есть только на вялое помахивание флажком. Ты как себя чувствуешь вообще?😱
Игнорирование симптомов может привести к серьёзным последствиям для здоровья!

Какие анализы сдать, что пропить и как исправить ситуацию — рассказал в бесплатном уроке! 
Если хочешь в текстовом виде - скачивай гайд. 📖
Хочешь задать лично свои вопросы - запишись на консультацию👇👇👇`;
            }

            let resultImage = '';
            if (formData.общий_балл <= 10) {
                resultImage = 'https://raw.githubusercontent.com/valedol190387/obukhovnewtest/refs/heads/main/photo_2025-03-14_02-30-13.jpg'; // URL для хорошего результата
            } else if (formData.общий_балл < 15) {
                resultImage = 'https://raw.githubusercontent.com/valedol190387/obukhovnewtest/refs/heads/main/xLGwC.jpg'; // URL для среднего результата
            } else {
                resultImage = 'https://raw.githubusercontent.com/valedol190387/obukhovnewtest/refs/heads/main/ironman.png'; // URL для плохого результата
            }

            resultsCard.innerHTML = `
                <h2>Результаты теста</h2>
                <p class="score">Твой общий балл: ${formData.общий_балл}</p>
                <img src="${resultImage}" alt="Результат теста" class="result-image">
                <div class="result-text">${resultText}</div>
                <a href="https://t.me/obukhov_channel_bot/education" target="_blank" rel="noopener noreferrer" class="lesson-button">${formData.общий_балл <= 10 ? 'Получить материалы' : 'Низкое железо: что делать?'}</a>
            `;

            document.querySelector('.container').appendChild(resultsCard);
            
            // Добавляем футер
            const footer = document.createElement('div');
            footer.className = 'footer';
            footer.innerHTML = `<a href="https://t.me/maxim_obukhov" target="_blank">Если возникли сложности - напишите мне лично</a>`;
            document.querySelector('.container').appendChild(footer);
        }

        // Функция для показа экрана с приглашением подписаться
        function showSubscriptionScreen() {
            // Очищаем весь контейнер
            const container = document.querySelector('.container');
            // Сохраняем прогресс-бар
            const progressBar = document.querySelector('.progress-bar');
            const progressBarClone = progressBar ? progressBar.cloneNode(true) : null;
            
            // Очищаем содержимое контейнера
            container.innerHTML = '';
            
            // Возвращаем прогресс-бар
            if (progressBarClone) {
                container.appendChild(progressBarClone);
            }

            const subscriptionCard = document.createElement('div');
            subscriptionCard.className = 'subscription-card';
            
            subscriptionCard.innerHTML = `
                <h2>Для получения результатов теста</h2>
                <p>Вам необходимо быть подписанным на канал:</p>
                <p class="channel-name">"Биохакинг |Максим Обухов | Нутрициология"</p>
                <a href="https://t.me/obukhov_channel" target="_blank" rel="noopener noreferrer" class="subscribe-button">Подписаться</a>
                <button class="check-subscription-button" onclick="checkSubscription()">Проверить подписку</button>
            `;
            
            document.querySelector('.container').appendChild(subscriptionCard);
            
            // Добавляем футер
            const footer = document.createElement('div');
            footer.className = 'footer';
            footer.innerHTML = `<a href="https://t.me/maxim_obukhov" target="_blank">Если возникли сложности - напишите мне лично</a>`;
            document.querySelector('.container').appendChild(footer);
        }

        // Обновляем функцию отправки начальных данных
        async function sendInitialData() {
            try {
                const initData = {
                    telegramId: tg.initDataUnsafe?.user?.id || null
                };

                // Получаем UTM-параметры
                const utmParams = getStartAppParams();
                if (utmParams) {
                    Object.assign(initData, utmParams);
                }

                console.log('Отправляемые начальные данные:', initData); // Для отладки

                const response = await fetch('https://n8n.snapn8n.ru/webhook/fcf73fe1-81b0-4c38-89ac-c3d0317126f9', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(initData)
                });

                if (!response.ok) {
                    console.error('Ошибка при отправке начальных данных');
                }
            } catch (error) {
                console.error('Ошибка:', error);
            }
        }

        // ЕДИНСТВЕННЫЙ обработчик DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            // Инициализация Telegram WebApp
            webapp.ready();
            
            console.log('Инициализируем кнопки Telegram');
            
            // Проверяем, есть ли сохраненный прогресс
            const hasProgress = loadProgress();
            
            // Сначала явно заставляем MainButton отобразиться
            try {
                mainButton.setText('Далее');
                mainButton.setParams({
                    text: 'Далее',
                    color: '#8774e1',
                    text_color: '#ffffff',
                    is_visible: true,
                    is_active: true
                });
                mainButton.show();
                console.log('MainButton инициализирована');
            } catch (error) {
                console.error('Ошибка при настройке MainButton:', error);
            }
            
            // Инициализация SecondaryButton
            try {
                secondaryButton.setText('Назад');
                secondaryButton.setParams({
                    text_color: '#8774e1',
                    is_visible: currentQuestion > 1,
                    is_active: true
                });
                
                secondaryButton.onClick(function() {
                    console.log('Клик по SecondaryButton');
                    if (currentQuestion > 1) {
                        currentQuestion--;
                        showQuestion(currentQuestion);
                    }
                });
                
                if (currentQuestion > 1) {
                    secondaryButton.show();
                } else {
                    secondaryButton.hide();
                }
                console.log('SecondaryButton инициализирована');
            } catch (error) {
                console.error('Ошибка при настройке SecondaryButton:', error);
            }
            
            // Установка основного обработчика клика для MainButton
            try {
                mainButton.offClick(); // Сначала удаляем все предыдущие обработчики
                mainButton.onClick(function() {
                    console.log('Клик по MainButton на вопросе', currentQuestion);
                    if (validateQuestion(currentQuestion)) {
                        if (currentQuestion < totalQuestions) {
                            console.log('Переход к следующему вопросу:', currentQuestion + 1);
                            nextQuestion(currentQuestion);
                        } else {
                            console.log('Последний вопрос, отправляем форму...');
                            const form = document.getElementById('testForm');
                            if (form) {
                                console.log('Форма найдена, вызываем событие submit');
                                form.dispatchEvent(new Event('submit'));
                            } else {
                                console.error('Форма не найдена!');
                            }
                        }
                    } else {
                        if (currentQuestion === 3) {
                            alert('Пожалуйста, оцените все симптомы (от 0 до 4)');
                        } else {
                            alert('Пожалуйста, ответьте на вопрос');
                        }
                    }
                });
                console.log('Установлен обработчик клика для MainButton');
            } catch (error) {
                console.error('Ошибка при установке обработчика MainButton:', error);
            }
            
            // Модифицируем обработчик изменения ответов - убираем автоматическую валидацию
            document.addEventListener('change', function(e) {
                if (e.target.type === 'radio' || e.target.type === 'checkbox' || e.target.type === 'text') {
                    mainButton.enable(); // Всегда активируем кнопку при изменении
                    // Сохраняем изменения в localStorage
                    // Обновляем formData на основе текущих ответов
                    formData = collectFormData();
                    saveProgress();
                }
            });
            
            // Инициализация остальных компонентов
            setupEventListeners();
            updateProgressBar();
            // Если есть сохраненный прогресс, показываем вопрос, на котором остановились
            // Иначе показываем первый вопрос
            showQuestion(currentQuestion);
            
            // Отправка начальных данных
            sendInitialData();
            
            // Настройка формы
            const form = document.getElementById('testForm');
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    console.log('Событие отправки формы вызвано!');
                    
                    try {
                        // Собираем данные формы
                        const formData = collectFormData();
                        // Сохраняем данные формы в глобальной переменной для последующего использования
                        window.savedFormData = formData;

                        console.log('Отправляемые данные:', formData); // Для отладки

                        // Скрываем обе кнопки после отправки формы
                        console.log('Скрываем кнопки после отправки');
                        mainButton.hide();
                        secondaryButton.hide();
                        
                        // Отправляем на вебхук
                        console.log('Начинаем отправку данных на вебхук...');
                        const response = await fetch('https://n8n.snapn8n.ru/webhook/8d5c2eef-e824-411a-9e05-d5562d1143cc', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify(formData)
                        });

                        console.log('Ответ от сервера:', response.status);
                        
                        if (!response.ok) {
                            console.error('Ошибка отправки данных:', response.status, response.statusText);
                            alert('Произошла ошибка при отправке данных, но вы можете продолжить.');
                        }
                        
                        // Проверяем подписку на канал
                        console.log('Проверяем подписку на канал...');
                        const userData = {
                            telegramId: tg.initDataUnsafe?.user?.id || null
                        };
                        
                        const subscriptionResponse = await fetch('https://n8n.snapn8n.ru/webhook/d2293db4-9b3b-4cd9-b462-bfce67951bd6', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify(userData)
                        });
                        
                        console.log('Статус ответа проверки подписки:', subscriptionResponse.status);
                        
                        if (subscriptionResponse.status === 200) {
                            // Пользователь подписан, показываем результаты
                            console.log('Пользователь подписан, показываем результаты');
                            showTestResults();
                        } else {
                            // Пользователь не подписан, показываем экран с приглашением подписаться
                            console.log('Пользователь не подписан, показываем экран подписки');
                            showSubscriptionScreen();
                        }

                    } catch (error) {
                        console.error('Ошибка:', error);
                        // При ошибке показываем страницу подписки на всякий случай
                        showSubscriptionScreen();
                    }
                });
            }
            
            // Добавляем в конце инициализации дополнительную проверку
            updateBackButton();
            
            // Еще раз проверяем, что MainButton видима
            setTimeout(() => {
                console.log('Проверка видимости кнопок через 1 секунду');
                console.log('MainButton видима:', mainButton.isVisible);
                mainButton.show();
            }, 1000);
        });
    </script>
</body>
</html>
